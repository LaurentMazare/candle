<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <title>Candle Segment Anything Model (SAM) Rust/WASM</title>
  </head>
  <body></body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@200;300;400&family=Source+Sans+3:wght@100;200;300;400;500;600;700;800;900&display=swap");
      html,
      body {
        font-family: "Source Sans 3", sans-serif;
      }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
      import init, { Model } from "./build/m.js";
      const MODEL_BASEURL =
        " https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2/resolve/refs%2Fpr%2F21/";

      async function fetchArrayBuffer(url, cacheModel = true) {
        if (!cacheModel)
          return new Uint8Array(await (await fetch(url)).arrayBuffer());
        const cacheName = "bert-candle-cache";
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(url);
        if (cachedResponse) {
          const data = await cachedResponse.arrayBuffer();
          return new Uint8Array(data);
        }
        const res = await fetch(url, { cache: "force-cache" });
        cache.put(url, res.clone());
        return new Uint8Array(await res.arrayBuffer());
      }
      async function run() {
        const configURL = MODEL_BASEURL + "config.json";
        const tokenizerURL = MODEL_BASEURL + "tokenizer.json";
        const modelURL = MODEL_BASEURL + "model.safetensors";

        await init();
        const [weightsArrayU8, tokenizerArrayU8, configArrayU8] =
          await Promise.all([
            fetchArrayBuffer(modelURL),
            fetchArrayBuffer(tokenizerURL),
            fetchArrayBuffer(configURL),
          ]);
        console.log("Loaded model", weightsArrayU8.length);
        console.log("Loaded tokenizer", tokenizerArrayU8.length);
        console.log("Loaded config", configArrayU8.length);

        const model = new Model(
          weightsArrayU8,
          tokenizerArrayU8,
          configArrayU8
        );

        const input = "Hello World!";
        const output = model.get_embeddings({
          sentences: ["hello how are you"],
          normalize_embeddings: true,
        });
        console.log(output);
      }
      globalThis.run = run;
    </script>
  </head>
  <body class="container max-w-4xl mx-auto p-4"></body>
</html>
